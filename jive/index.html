<!DOCTYPE HTML>
<html>
<head>
<!--  taken from https://github.com/johan/js-deflate -->
<script src="rawdeflate.js"></script>
<script src="plantuml.js" type="text/javascript"></script>
<script type="text/javascript" src="papaparse.min.js"></script>
<script>
$ = function(id){ return document.getElementById(id) };

function encode64(data) {
	r = "";
	for (i=0; i<data.length; i+=3) {
 		if (i+2==data.length) {
			r +=append3bytes(data.charCodeAt(i), data.charCodeAt(i+1), 0);
		} else if (i+1==data.length) {
			r += append3bytes(data.charCodeAt(i), 0, 0);
		} else {
			r += append3bytes(data.charCodeAt(i), data.charCodeAt(i+1),
				data.charCodeAt(i+2));
		}
	}
	return r;
	alert(r);
}

function append3bytes(b1, b2, b3) {
	c1 = b1 >> 2;
	c2 = ((b1 & 0x3) << 4) | (b2 >> 4);
	c3 = ((b2 & 0xF) << 2) | (b3 >> 6);
	c4 = b3 & 0x3F;
	r = "";
	r += encode6bit(c1 & 0x3F);
	r += encode6bit(c2 & 0x3F);
	r += encode6bit(c3 & 0x3F);
	r += encode6bit(c4 & 0x3F);
	return r;
}

function encode6bit(b) {
	if (b < 10) {
 		return String.fromCharCode(48 + b);
	}
	b -= 10;
	if (b < 26) {
 		return String.fromCharCode(65 + b);
	}
	b -= 26;
	if (b < 26) {
 		return String.fromCharCode(97 + b);
	}
	b -= 26;
	if (b == 0) {
 		return '-';
	}
	if (b == 1) {
 		return '_';
	}
	return '?';
}

function compress(s) {
  //UTF8
  s = unescape(encodeURIComponent(s));
  //$('im').src = "http://www.plantuml.com/plantuml/img/"+encode64(zip_deflate(s, 9));
  $('im').src = "http://www.plantuml.com/plantuml/img/"+encode64(deflate(s, 9));
}
</script>
<script type="text/javascript">
    function read (){

        Papa.parse(document.getElementById('csv').files[0], {
            download: true,
            header: true,
            complete: function(results) {
                var i = 0;
                const attributes = new Set();
                while(1){
                    try{
                        if(results.data[i]["System Start"]== "Field Write"){
                            //console.log(results.data[i]);
                            var k = results.data[i][""].split("=")[1] + "->"+results.data[i].__parsed_extra[0].split("=")[0];
                            attributes.add(k);
                            //console.log(k);
                        }
                        i++;
                    }
                    catch{
                        break
                    }
                }
                console.log(attributes);
                var array_attributes = Array.from(attributes);
                var select1 = document.getElementById("select1");
                while(select1.length>0){
                    select1.remove(0);
                }
                for (var i = 0; i < array_attributes.length; i++) {
                    var o = document.createElement("option");
                    o.value = array_attributes[i];
                    o.text = array_attributes[i];
                    select1.appendChild(o);
                }
            }
        });
    };

    function trace(){

        Papa.parse(document.getElementById('csv').files[0], {
            download: true,
            header: true,
            complete: function(results) {
                var i = 0;
                var output = "@startuml\n\nhide empty description\n";
                var states = new Set();
                var transitions = new Set();
                var curr_state = "";
                var keyAttributes = document.getElementById("key_attributes").value.split(";");
                keyAttributes.pop();
                for(i=0;i<keyAttributes.length;i++){
                    if(i==keyAttributes.length-1)curr_state+="null";
                    else curr_state+="null_";
                }
                output+=("[*] -> "+curr_state+"\n");
                states.add(curr_state);
                var count = 0;
                console.log(keyAttributes);
                while(1){
                    try{
                        if(results.data[i]["System Start"]== "Field Write"){
                            var k = results.data[i][""].split("=")[1] + "->"+results.data[i].__parsed_extra[0].split("=")[0];
                            count+=1;
                            if(keyAttributes.includes(k)){
                                console.log(k+" "+keyAttributes.indexOf(k) );
                                var temp =results.data[i].__parsed_extra[0].split("=")[1];
                                
                                var next_state = "";
                               
                                if(keyAttributes.length==1){
                                    next_state = temp;
                                }
                                else{
                                    //console.log("Saran")
                                    
                                    const temp_arr = curr_state.split("_");
                                    var attribute_index = keyAttributes.indexOf(k);
                                    //console.log("attr_ind = "+attribute_index)
                                    //console.log(temp_arr);
                                    temp_arr[attribute_index] = temp;
                                    //console.log(temp_arr)
                                    next_state = temp_arr.join("_");
                                    
                                }
                                console.log(curr_state);
                                console.log(next_state);
                                
                                var transit = (curr_state+" -> "+next_state+"\n"); 
                                console.log(transit);
                                if(!transitions.has(transit)){
                                    output+=transit;
                                    transitions.add(transit);
                                }
                                if(states.has(temp)){ 
                                    curr_state = next_state;
                                }
                                else{
                                    curr_state = next_state;
                                    states.add(next_state);
                                }
                            }
                        }
                        i++;
                    }
                    catch{
                        break
                    }
                }
                //console.log(count);
                output+="\n@enduml";
                document.getElementById("inflated").value = output;
            }
        });
    };
    function add_key_attr(){
        document.getElementById("key_attributes").value += (document.getElementById("select1").value)+";";
    };

    function clear_uml(){
        document.getElementById("inflated").value = "";
    };
</script>
</head>

<body>
    <center>
        <h1>State Diagram Builder from Execution Trace</h1>
        <form>
            <input type="file" multiple="false" accept="*test/csv" id="csv" onchange="clear_uml()">
            <br><br><br>
            <textarea id="inflated" cols="64" rows="16" name="umlarea"></textarea>
            <p>
            <input type=submit value = "Upload" onclick="read();return false;"></p>
            Attributes: <select id="select1"></select>
            <input type=submit value = "Add" onclick="add_key_attr();return false;"></p>
            
            Key Attributes: <input type="text" id="key_attributes">
            
            <input type=submit value = "Trace" onclick="trace();return false;"></p>
            <input type=submit value = "Draw" onclick="compress($('inflated').value);return false;"></p>
            
            <img id="im" src="" alt="No image">
            </form>            
    </center>
</body>
</html>